name: CI - E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ '*' ]
  workflow_dispatch:

jobs:
  test:
    name: Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run Playwright tests
        run: npm run test -- --project=${{ matrix.browser }}
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 30

  test-docker:
    name: Docker Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: agibank-e2e-tests:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Run tests in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/test-results:/app/test-results \
            -v ${{ github.workspace }}/playwright-report:/app/playwright-report \
            agibank-e2e-tests:latest npm run test:chromium

      - name: Upload Docker test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, test-docker]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate summary
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests executed across multiple browsers and Docker" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY

  generate-report:
    name: Generate Final Report
    runs-on: ubuntu-latest
    needs: [test, test-docker]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Consolidate test results
        run: |
          mkdir -p consolidated-results/test-results
          mkdir -p consolidated-results/playwright-report
          
          echo "ðŸ“¦ Consolidating test results from all artifacts..."
          
          # Process each artifact directory
          for artifact_dir in all-artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              echo "Processing: $artifact_dir"
              
              # Copy test-results directory if it exists
              if [ -d "$artifact_dir/test-results" ]; then
                echo "  â†’ Copying test-results..."
                cp -r "$artifact_dir/test-results"/* consolidated-results/test-results/ 2>/dev/null || true
              fi
              
              # Copy playwright-report directory if it exists
              if [ -d "$artifact_dir/playwright-report" ]; then
                echo "  â†’ Copying playwright-report..."
                cp -r "$artifact_dir/playwright-report"/* consolidated-results/playwright-report/ 2>/dev/null || true
              fi
              
              # Copy individual files (screenshots, videos, etc.)
              find "$artifact_dir" -type f \( -name "*.png" -o -name "*.webm" -o -name "*.json" -o -name "*.zip" \) -exec cp {} consolidated-results/test-results/ \; 2>/dev/null || true
              
              # Copy HTML files
              find "$artifact_dir" -type f -name "*.html" -exec cp {} consolidated-results/playwright-report/ \; 2>/dev/null || true
              
              # Copy trace directories
              find "$artifact_dir" -type d -name "trace" -exec cp -r {} consolidated-results/test-results/ \; 2>/dev/null || true
            fi
          done
          
          echo ""
          echo "ðŸ“Š Consolidated test results summary:"
          echo "  Screenshots: $(find consolidated-results/test-results -name "*.png" 2>/dev/null | wc -l)"
          echo "  Videos: $(find consolidated-results/test-results -name "*.webm" 2>/dev/null | wc -l)"
          echo "  HTML Reports: $(find consolidated-results/playwright-report -name "*.html" 2>/dev/null | wc -l)"
          echo "  JSON Results: $(find consolidated-results/test-results -name "*.json" 2>/dev/null | wc -l)"
          echo "  Trace Directories: $(find consolidated-results/test-results -type d -name "trace" 2>/dev/null | wc -l)"

      - name: Generate HTML report
        run: |
          # Try to generate a consolidated report if possible
          if [ -d "consolidated-results/playwright-report" ] && [ "$(ls -A consolidated-results/playwright-report)" ]; then
            echo "âœ… HTML reports found in artifacts"
          else
            echo "âš ï¸ No HTML reports found, but test results are available"
          fi

      - name: Upload consolidated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-test-report
          path: |
            consolidated-results/test-results/
            consolidated-results/playwright-report/
          retention-days: 30
          if-no-files-found: warn

      - name: Generate report summary
        run: |
          echo "## ðŸ“Š Consolidated Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count screenshots
          SCREENSHOT_COUNT=$(find consolidated-results/test-results -name "*.png" 2>/dev/null | wc -l || echo "0")
          echo "- ðŸ“¸ Screenshots: $SCREENSHOT_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # Count videos
          VIDEO_COUNT=$(find consolidated-results/test-results -name "*.webm" 2>/dev/null | wc -l || echo "0")
          echo "- ðŸŽ¥ Videos: $VIDEO_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # Count HTML reports
          HTML_COUNT=$(find consolidated-results/playwright-report -name "*.html" 2>/dev/null | wc -l || echo "0")
          echo "- ðŸ“„ HTML Reports: $HTML_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # Count trace files
          TRACE_COUNT=$(find consolidated-results/test-results -type d -name "trace" 2>/dev/null | wc -l || echo "0")
          echo "- ðŸ” Traces: $TRACE_COUNT" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the **consolidated-test-report** artifact to access:" >> $GITHUB_STEP_SUMMARY
          echo "- All screenshots from test failures" >> $GITHUB_STEP_SUMMARY
          echo "- All video recordings" >> $GITHUB_STEP_SUMMARY
          echo "- HTML reports for each browser" >> $GITHUB_STEP_SUMMARY
          echo "- Trace files for debugging" >> $GITHUB_STEP_SUMMARY


